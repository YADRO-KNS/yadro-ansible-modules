---
# Prepare

- name: Prepare | Setup connection parameters
  set_fact: &connection_info
    connection:
      hostname:       "{{ connection_hostname }}"
      port:           "{{ connection_port }}"
      username:       "{{ connection_username }}"
      password:       "{{ connection_password }}"
      validate_certs: "{{ connection_validate_certs }}"

- name: Prepare | Ensure user absent before test
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    state: "absent"
  delegate_to: localhost

# Test user creation

- name: Test user creation | Create TestUser
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    password: "TestPass123"
    role: "Operator"
    enabled: true
    state: "present"
  register: result
  delegate_to: localhost

- name: Test user creation | Check user created and state changed
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Account created.'"

# Test check mode

- name: Test check mode | Create TestUser
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    password: "TestPass123"
    role: "Operator"
    enabled: true
    state: "present"
  delegate_to: localhost

- name: Test check mode | Delete user in check mode
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    state: "absent"
  check_mode: true
  delegate_to: localhost

- name: Test check mode | Ensure user exists
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    state: "present"
  register: result
  delegate_to: localhost

- name: Test check mode | Check state didn't changed
  assert:
    that:
      - "result.changed == false"
      - "result.msg == 'No changes required.'"

# Test user configuration

- name: Test user configuration | Disable TestUser
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    enabled: false
  register: result
  delegate_to: localhost

- name: Test user configuration | Check user modified
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Account updated.'"

# Test user deletion

- name: Test user deletion | Delete TestUser
  yadro.obmc.bmc_account:
    <<: *connection_info
    username: "TestUser"
    state: "absent"
  register: result
  delegate_to: localhost

- name: Test user deletion | Check user deleted
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Account deleted.'"
