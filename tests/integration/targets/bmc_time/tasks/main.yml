---
# Prepare

- name: Prepare | Setup connection parameters
  set_fact: &connection_info
    connection:
      hostname:       "{{ connection_hostname }}"
      port:           "{{ connection_port }}"
      username:       "{{ connection_username }}"
      password:       "{{ connection_password }}"
      validate_certs: "{{ connection_validate_certs }}"

- name: Prepare | Ensure NTP disabled before tests
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: false
    ntp_servers: []
  delegate_to: localhost

# Test NTP configuration

- name: Test NTP configuration | Configure NTP servers
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: true
    ntp_servers:
      - 192.168.1.100
      - 192.168.2.100
  register: result
  delegate_to: localhost

- name: Test NTP configuration | Check configuration updated
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Configuration updated.'"

- name: Test NTP configuration | Configure NTP servers again
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: true
    ntp_servers:
      - 192.168.1.100
      - 192.168.2.100
  register: result
  delegate_to: localhost

- name: Test NTP configuration | Check configuration didn't changed
  assert:
    that:
      - "result.changed == false"
      - "result.msg == 'No changes required.'"

# Test check mode

- name: Test check mode | Configure NTP servers
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: true
    ntp_servers:
      - 192.168.1.100
  delegate_to: localhost

- name: Test check mode | Modify NTP servers in check mode
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: false
    ntp_servers:
      - 192.168.1.1
  check_mode: true
  delegate_to: localhost

- name: Test check mode | Configure NTP servers
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: true
    ntp_servers:
      - 192.168.1.100
  delegate_to: localhost

- name: Test check mode | Check configuration didn't changed
  assert:
    that:
      - "result.changed == false"
      - "result.msg == 'No changes required.'"

# Test modification

- name: Test modification | Configure NTP servers
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: true
    ntp_servers:
      - 192.168.1.100
  delegate_to: localhost

- name: Test modification | Change NTP servers
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: false
  register: result
  delegate_to: localhost

- name: Test modification | Check time configuration updated
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Configuration updated.'"

- name: Test modification | Remove NTP servers
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: true
    ntp_servers: []
  register: result
  delegate_to: localhost

- name: Test modification | Check configuration updated
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Configuration updated.'"


- name: Test modification | Disable NTP support
  yadro.obmc.bmc_time:
    <<: *connection_info
    ntp_enabled: false
  register: result
  delegate_to: localhost

- name: Test modification | Check configuration updated
  assert:
    that:
      - "result.changed == true"
      - "result.msg == 'Configuration updated.'"
